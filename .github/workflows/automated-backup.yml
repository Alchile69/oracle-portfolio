name: Automated Backup

on:
  schedule:
    # Backup quotidien Ã  2h00 UTC
    - cron: '0 2 * * *'
    # Backup hebdomadaire le dimanche Ã  3h00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type de backup'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - configs
        - data
        - code
        - incremental

jobs:
  automated-backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique Git
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Determine backup type
      id: backup-type
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          if [ "${{ github.event.schedule }}" = "0 2 * * *" ]; then
            echo "type=incremental" >> $GITHUB_OUTPUT
          else
            echo "type=full" >> $GITHUB_OUTPUT
          fi
        else
          echo "type=${{ github.event.inputs.backup_type }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create backup directory
      run: mkdir -p backups
      
    - name: Run backup
      run: ./scripts/backup.sh ${{ steps.backup-type.outputs.type }} ./backups
      
    - name: List backup files
      run: |
        echo "ğŸ“‹ Fichiers de backup crÃ©Ã©s:"
        ls -lah backups/
        
    - name: Upload backup artifacts
      uses: actions/upload-artifact@v4
      with:
        name: oracle-portfolio-backup-${{ steps.backup-type.outputs.type }}-${{ github.run_number }}
        path: backups/*.tar.gz
        retention-days: 30
        
    - name: Create backup release (weekly only)
      if: github.event.schedule == '0 3 * * 0'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: backup-${{ github.run_number }}-$(date +'%Y%m%d')
        name: Weekly Backup - $(date +'%Y-%m-%d')
        body: |
          ğŸ—„ï¸ **Backup Automatique Oracle Portfolio**
          
          - **Type** : ${{ steps.backup-type.outputs.type }}
          - **Date** : $(date)
          - **Commit** : ${{ github.sha }}
          - **Branche** : ${{ github.ref_name }}
          
          ## Contenu
          - âœ… Configurations Firebase
          - âœ… Code source complet
          - âœ… Tests automatisÃ©s
          - âœ… Documentation
          - âœ… Scripts de dÃ©ploiement
          - âœ… Historique Git
          
          ## Restauration
          ```bash
          # TÃ©lÃ©charger et extraire
          tar -xzf oracle-portfolio-backup-*.tar.gz
          cd oracle-portfolio-backup-*
          
          # Installer et tester
          npm ci --legacy-peer-deps
          npm test
          
          # DÃ©ployer
          ./scripts/deploy.sh development
          ```
        files: backups/*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Cleanup old artifacts
      run: |
        echo "ğŸ§¹ Nettoyage des anciens backups..."
        # Garder seulement les 5 derniers backups dans artifacts
        # (La suppression automatique est gÃ©rÃ©e par GitHub Actions retention)
        
    - name: Backup verification
      run: |
        echo "ğŸ” VÃ©rification des backups crÃ©Ã©s..."
        for backup in backups/*.tar.gz; do
          if [ -f "$backup" ]; then
            echo "âœ… Backup vÃ©rifiÃ©: $(basename "$backup")"
            echo "   Taille: $(du -sh "$backup" | cut -f1)"
            echo "   Fichiers: $(tar -tzf "$backup" | wc -l)"
          fi
        done
        
    - name: Send notification (on failure)
      if: failure()
      run: |
        echo "âŒ Ã‰chec du backup automatisÃ©"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”§ Type: ${{ steps.backup-type.outputs.type }}"
        echo "ğŸ“‹ Logs disponibles dans les artifacts GitHub Actions"
        
    - name: Success notification
      if: success()
      run: |
        echo "âœ… Backup automatisÃ© rÃ©ussi"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”§ Type: ${{ steps.backup-type.outputs.type }}"
        echo "ğŸ“¦ Artifacts disponibles pour 30 jours"

